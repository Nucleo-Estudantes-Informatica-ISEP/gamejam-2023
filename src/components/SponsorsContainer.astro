---
import Header from './Header.astro';
import Sponsor from './Sponsor.astro';
---

<section
  class="flex items-center gap-8 justify-center flex-col gap-y-12 text-white font-misterPixel uppercase"
>
  <Header>Patrocinadores</Header>
  <div id="container" class="grid grid-cols-4 gap-24 py-12 relative">
    <img id="pacman" class="absolute w-16 h-16 -top-10 -left-10" src="/pacman.gif" alt="Pacman" />
    <div id="food" class="absolute h-8 w-8 bg-yellow-500 rounded-full animate-pacman-food"></div>
    <Sponsor />
    <Sponsor />
    <Sponsor />
    <Sponsor />
    <Sponsor />
    <Sponsor />
    <Sponsor />
    <Sponsor />
  </div>
</section>

<script is:inline>
  const pacman = document.getElementById('pacman');
  const sponsors = document.querySelectorAll('#sponsor');
  const food = document.getElementById('food');
  const container = document.getElementById('container');

  const STEP = 24;

  document.addEventListener('keydown', (event) => {
    event.preventDefault();
    if (event.key === 'ArrowUp' || event.key === 'w') {
      if (
        colidesWithAny(
          {
            x: pacman.getBoundingClientRect().x,
            y: pacman.getBoundingClientRect().y - STEP,
            width: pacman.getBoundingClientRect().width
          },
          sponsors
        )
      )
        return;
      pacman.style.top = `${pacman.offsetTop - STEP}px`;
      pacman.style.rotate = '-90deg';
    } else if (event.key === 'ArrowDown' || event.key === 's') {
      if (
        colidesWithAny(
          {
            x: pacman.getBoundingClientRect().x,
            y: pacman.getBoundingClientRect().y + STEP,
            width: pacman.getBoundingClientRect().width
          },
          sponsors
        )
      )
        return;
      pacman.style.top = `${pacman.offsetTop + STEP}px`;
      pacman.style.rotate = '90deg';
    } else if (event.key === 'ArrowLeft' || event.key === 'a') {
      if (
        colidesWithAny(
          {
            x: pacman.getBoundingClientRect().x - STEP,
            y: pacman.getBoundingClientRect().y,
            width: pacman.getBoundingClientRect().width
          },
          sponsors
        )
      )
        return;
      pacman.style.rotate = '180deg';
      pacman.style.left = `${pacman.offsetLeft - STEP}px`;
    } else if (event.key === 'ArrowRight' || event.key === 'd') {
      if (
        colidesWithAny(
          {
            x: pacman.getBoundingClientRect().x + STEP,
            y: pacman.getBoundingClientRect().y,
            width: pacman.getBoundingClientRect().width
          },
          sponsors
        )
      )
        return;
      pacman.style.left = `${pacman.offsetLeft + STEP}px`;
      pacman.style.rotate = '0deg';
    }
    checkFoodColision();
  });

  const checkFoodColision = () => {
    if (
      colides(
        {
          x: pacman.getBoundingClientRect().x,
          y: pacman.getBoundingClientRect().y,
          width: pacman.getBoundingClientRect().width
        },
        food
      )
    ) {
      food.remove();
      const newFood = spawnFood();
      container.appendChild(food);
      food.style.top = `${newFood.y}px`;
      food.style.left = `${newFood.x}px`;
    }
  };

  const spawnFood = () => {
    const x = Math.floor(Math.random() * window.innerWidth);
    const y = Math.floor(Math.random() * window.innerHeight);

    if (
      colidesWithAny(
        {
          x,
          y,
          width: food.getBoundingClientRect().width * 1.2
        },
        sponsors
      )
    )
      return spawnFood();

    if (colides({ x, y, width: food.getBoundingClientRect().width }, pacman)) return spawnFood();

    if (
      x < 0 ||
      x > window.innerWidth - window.innerWidth / 4 ||
      y < 0 ||
      y > window.innerHeight - window.innerHeight / 4
    )
      return spawnFood();

    return { x, y };
  };

  const colidesWithAny = ({ x, y, width }, sponsors) => {
    for (let i = 0; i < sponsors.length; i++)
      if (colides({ x, y, width }, sponsors[i])) return true;

    if (x < 0 || x > window.innerWidth || y < 0 || y > window.innerHeight) return true;
    return false;
  };

  const colides = ({ x, y, width }, subject) => {
    const subjectRect = subject.getBoundingClientRect();

    if (
      x < subjectRect.x + subjectRect.width &&
      x + width > subjectRect.x &&
      y < subjectRect.y + subjectRect.height &&
      y + width > subjectRect.y
    )
      return true;

    return false;
  };

  spawnFood();
</script>
